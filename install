#! /usr/bin/env bash

set -euo pipefail

INSTALL_DIR="$HOME/.jrnl/bin"
TARGET_FILE="$INSTALL_DIR/jrnl"
JRNL_REPO_URL="https://raw.githubusercontent.com/alvpickmans/jrnl/refs/heads/main/jrnl"
MANUAL_INSTRUCTIONS=false

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

print_success() {
    echo -e "${GREEN}✓ $1${NC}"
}

print_error() {
    echo -e "${RED}✗ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}⚠ $1${NC}"
}

# Create install directory
mkdir -p "$INSTALL_DIR"

# Download jrnl script
echo "Downloading jrnl script..."
if curl -fsSL "$JRNL_REPO_URL" -o "$TARGET_FILE"; then
    print_success "Downloaded jrnl to $TARGET_FILE"
elif wget -qO "$TARGET_FILE" "$JRNL_REPO_URL" 2>/dev/null; then
    print_success "Downloaded jrnl to $TARGET_FILE"
else
    print_error "Failed to download jrnl script"
    print_warning "Make sure you have curl or wget installed"
    exit 1
fi

# Make script executable
chmod +x "$TARGET_FILE"
print_success "Made jrnl executable"

# Function to add to PATH
add_to_path() {
    local config_file="$1"
    local path_line="$2"
    
    if [ -f "$config_file" ]; then
        if ! grep -q "\.jrnl/bin" "$config_file" 2>/dev/null; then
            echo "" >> "$config_file"
            echo "$path_line" >> "$config_file"
            print_success "Added to PATH in $config_file"
        else
            print_warning "Already in PATH in $config_file"
        fi
        return 0
    else
        return 1
    fi
}

# Try to add to shell configs
echo ""
echo "Adding to PATH..."

# Bash
if ! add_to_path "$HOME/.bashrc" 'export PATH="$HOME/.jrnl/bin:$PATH"'; then
    MANUAL_INSTRUCTIONS=true
fi

# Zsh
if ! add_to_path "$HOME/.zshrc" 'export PATH="$HOME/.jrnl/bin:$PATH"'; then
    MANUAL_INSTRUCTIONS=true
fi

# Fish
fish_config_dir="$HOME/.config/fish"
if [ -d "$fish_config_dir" ]; then
    if ! add_to_path "$fish_config_dir/config.fish" 'set -gx PATH $HOME/.jrnl/bin $PATH'; then
        MANUAL_INSTRUCTIONS=true
    fi
else
    MANUAL_INSTRUCTIONS=true
fi

# Print success message
echo ""
print_success "Installation complete!"
echo ""
echo "To use jrnl, restart your shell or run:"

# Print shell-specific source commands
if [ -f "$HOME/.bashrc" ]; then
    echo "  source ~/.bashrc          # for bash"
fi
if [ -f "$HOME/.zshrc" ]; then
    echo "  source ~/.zshrc           # for zsh"
fi
if [ -d "$fish_config_dir" ]; then
    echo "  source ~/.config/fish/config.fish   # for fish"
fi

# Print manual instructions if needed
if [ "$MANUAL_INSTRUCTIONS" = true ]; then
    echo ""
    print_warning "Some shell config files don't exist"
    echo ""
    echo "Manual setup instructions:"
    echo ""
    echo "For bash or zsh, add this line to your shell config file:"
    echo "  export PATH=\"\$HOME/.jrnl/bin:\$PATH\""
    echo ""
    echo "For fish, add this line to ~/.config/fish/config.fish:"
    echo "  set -gx PATH \$HOME/.jrnl/bin \$PATH"
    echo ""
    echo "Then restart your shell or source the config file."
fi

echo ""
echo "Verify installation by running: jrnl --version"
