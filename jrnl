#! /usr/bin/env bash

set -euo pipefail

VERSION="v0.1.1"

# Default values
JRNL_FILE="${JRNL_FILE:-$HOME/main.jrnl}"
FILE="$JRNL_FILE"
EDITOR="${EDITOR:-vi}"
MODE=""
NOTE_TEXT=""
INTERACTIVE=""
OPEN_EDITOR=""

show_help() {
    cat << EOF
jrnl - Simple Journal Command $VERSION

USAGE:
    jrnl "<note text>"             # Quick add entry
    jrnl -i [-e <editor>] "<text>" # Interactive add entry
    jrnl read                      # Show entire journal (pipeable)
    jrnl open [-e <editor>]        # Open journal in editor
    jrnl -v, jrnl --version        # Show version
    jrnl -h, jrnl --help           # Show usage

ENVIRONMENT:
    JRNL_FILE      Path to journal file (default: ~/main.jrnl)
    EDITOR         Editor to use (default: vi)

FLAGS:
    -i            Interactive mode (add detailed notes)
    -e <editor>   Use specified editor (for -i or open)
    -v, --version Show version
    -h, --help    Show this help message

EXAMPLES:
    jrnl "Important meeting at 3pm"
    jrnl 'TODO: review pull request'
    jrnl -i "Startup meeting"
    jrnl -i -e nano "Startup meeting"
    jrnl read | grep "meeting"
    jrnl read | less
    jrnl open
    jrnl open -e nano
EOF
}

get_today_date() {
    date +%Y-%m-%d
}

ensure_journal_file() {
    if [ ! -f "$FILE" ]; then
        local dir=$(dirname "$FILE")
        if [ ! -d "$dir" ]; then
            mkdir -p "$dir" 2>/dev/null || {
                echo "Error: Cannot create directory $dir" >&2
                exit 1
            }
        fi
        touch "$FILE" 2>/dev/null || {
            echo "Error: Cannot create file $FILE" >&2
            exit 1
        }
    fi
}

add_entry() {
    local text="$1"
    local today=$(get_today_date)
    
    if [ -s "$FILE" ]; then
        printf '\n' >> "$FILE"
    fi
    
    echo "${today} ${text}" >> "$FILE"
}

add_interactive_entry() {
    local title="$1"
    local editor="${2:-$EDITOR}"
    local today=$(get_today_date)
    
    local temp_file
    temp_file=$(mktemp "${TMPDIR:-/tmp}/jrnl.XXXXXXXX.jrnl")
    
    printf '%s %s\n' "$today" "$title" > "$temp_file"
    
    "$editor" "$temp_file"
    
    if [ -s "$temp_file" ]; then
        local first_line
        first_line=$(head -n1 "$temp_file")
        
        if [[ ! "$first_line" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}[[:space:]] ]]; then
            echo "Error: First line must be in 'YYYY-MM-DD title' format" >&2
            rm -f "$temp_file"
            exit 1
        fi
        
        local remaining_lines
        remaining_lines=$(tail -n +2 "$temp_file")
        
        if [ -n "$remaining_lines" ]; then
            if [ -s "$FILE" ]; then
                printf '\n' >> "$FILE"
            fi
            
            printf '%s\n' "$first_line" >> "$FILE"
            
            while IFS= read -r line || [ -n "$line" ]; do
                printf '%s\n' "$line" >> "$FILE"
            done <<< "$remaining_lines"
        fi
    fi
    
    rm -f "$temp_file"
}

read_journal() {
    ensure_journal_file
    cat "$FILE"
}

open_journal() {
    ensure_journal_file
    "$1" "$FILE"
}

# Parse arguments
if [ $# -eq 0 ]; then
    echo "Error: jrnl requires arguments" >&2
    show_help
    exit 1
fi

# Check for commands or help first
if [ "$1" = "read" ]; then
    MODE="read"
    shift
elif [ "$1" = "open" ]; then
    MODE="open"
    OPEN_EDITOR="$EDITOR"
    shift
    while [ $# -gt 0 ]; do
        case "$1" in
            -e|--editor)
                if [ $# -lt 2 ]; then
                    echo "Error: -e|--editor requires an argument" >&2
                    exit 1
                fi
                OPEN_EDITOR="$2"
                shift 2
                ;;
            *)
                echo "Error: Unexpected argument '$1' for open command" >&2
                exit 1
                ;;
        esac
    done
elif [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
    show_help
    exit 0
else
    # Collect flags first
    while [ $# -gt 0 ]; do
        case "$1" in
            -v|--version)
                echo "jrnl $VERSION"
                exit 0
                ;;
            -h|--help)
                show_help
                exit 0
                ;;
            -i)
                INTERACTIVE=1
                shift
                ;;
            -e|--editor)
                if [ $# -lt 2 ]; then
                    echo "Error: -e|--editor requires an argument" >&2
                    exit 1
                fi
                OPEN_EDITOR="$2"
                shift 2
                ;;
            *)
                # Not a flag, start collecting note text
                break
                ;;
        esac
    done
    
    # Collect all remaining text as note text
    if [ $# -eq 0 ]; then
        echo "Error: jrnl requires note text" >&2
        show_help
        exit 1
    fi
    
    # Require exactly one argument (text must be quoted if it contains spaces)
    if [ $# -gt 1 ]; then
        echo "Error: Note text must be a single quoted string" >&2
        echo "Usage: jrnl \"your note text\"" >&2
        exit 1
    fi
    
    NOTE_TEXT="$1"
fi

# Execute based on mode
case "$MODE" in
    read)
        read_journal
        ;;
    open)
        open_journal "$OPEN_EDITOR"
        ;;
    "")
        ensure_journal_file
        if [ -n "$INTERACTIVE" ]; then
            add_interactive_entry "$NOTE_TEXT" "$OPEN_EDITOR"
        else
            add_entry "$NOTE_TEXT"
        fi
        ;;
esac
